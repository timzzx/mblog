---
title: "TCP/IP学习理解(五)"
date: 2018-07-17T16:09:00+08:00
categories: [TCP/IP]
gitment: true
TableOfContents: true
---

# ICMP协议

>ICMP是（Internet Control Message Protocol）Internet控制报文协议。它是TCP/IP协议族的一个子协议，用于在IP主机、路由器之间传递控制消息。控制消息是指网络通不通、主机是否可达、路由是否可用等网络本身的消息。这些控制消息虽然并不传输用户数据，但是对于用户数据的传递起着重要的作用。<br />
> IP 协议并不是一个可靠的协议,它不保证数据被送达,那么,自然的,保证数据送达的工作应该由其他的模块来完 成。其中一个重要的模块就是 ICMP(网络控制报文)协议。

<hr />

## ICMP报文是在IP数据报内部

<table> <tr> <td> 长度20字节 </td> <td> - </td> </tr> <tr> <td> <b>IP首部</b> </td> <td> <b>ICMP报文</b> </td> </tr> </table>

<hr />

## ICMP报文

<table> <tr> <td> 类型 <b>TYPE</b> <i>8位</i> </td> <td> 代码 <b>CODE</b> <i>8位</i> </td> <td> 检验和 <b>Description</b> <i>16位</i> </td> </tr> </table>

<hr />

## ICMP类型的列表

>当传送 IP 数据包发生错误--比如主机不可达,路由不可达等等,ICMP 协议将会把错误信息封包,然后传送回给主机。给主机 一个处理错误的机会,这 也就是为什么说建立在 IP 层以上的协议是可能做到安全的原因。ICMP 数据包由8bit 的错误类型和8bit 的代 码和16bit 的校验和组成。而前 16bit 就组成了 ICMP 所要传递的信息。

<table><thead><tr><th>TYPE</th><th>CODE</th><th>Description</th><th>Query</th><th>Error</th></tr></thead><tr><td align="middle" valign="top">0</td><td align="middle" valign="top">0</td><td align="left" valign="top">Echo Reply——回显应答（Ping应答）</td><td align="middle" valign="top">x</td><td align="middle" valign="top">　</td></tr><tr><td align="middle" valign="top">3</td><td align="middle" valign="top">0</td><td align="left" valign="top">Network Unreachable——网络不可达</td><td align="middle" valign="top">　</td><td align="middle" valign="top">x</td></tr><tr><td align="middle" valign="top">3</td><td align="middle" valign="top">1</td><td align="left" valign="top">Host Unreachable——主机不可达</td><td align="middle" valign="top">　</td><td align="middle" valign="top">x</td></tr><tr><td align="middle" valign="top">3</td><td align="middle" valign="top">2</td><td align="left" valign="top">Protocol Unreachable——协议不可达</td><td align="middle" valign="top">　</td><td align="middle" valign="top">x</td></tr><tr><td align="middle" valign="top">3</td><td align="middle" valign="top">3</td><td align="left" valign="top">Port Unreachable——端口不可达</td><td align="middle" valign="top">　</td><td align="middle" valign="top">x</td></tr><tr><td align="middle" valign="top">3</td><td align="middle" valign="top">4</td><td align="left" valign="top">Fragmentation needed but no frag. bit set——需要进行分片但设置不分片比特</td><td align="middle" valign="top">　</td><td align="middle" valign="top">x</td></tr><tr><td align="middle" valign="top">3</td><td align="middle" valign="top">5</td><td align="left" valign="top">Source routing failed——源站选路失败</td><td align="middle" valign="top">　</td><td align="middle" valign="top">x</td></tr><tr><td align="middle" valign="top">3</td><td align="middle" valign="top">6</td><td align="left" valign="top">Destination network unknown——目的网络未知</td><td align="middle" valign="top">　</td><td align="middle" valign="top">x</td></tr><tr><td align="middle" valign="top">3</td><td align="middle" valign="top">7</td><td align="left" valign="top">Destination host unknown——目的主机未知</td><td align="middle" valign="top">　</td><td align="middle" valign="top">x</td></tr><tr><td align="middle" valign="top">3</td><td align="middle" valign="top">8</td><td align="left" valign="top">Source host isolated (obsolete)——源主机被隔离（作废不用）</td><td align="middle" valign="top">　</td><td align="middle" valign="top">x</td></tr><tr><td align="middle" valign="top">3</td><td align="middle" valign="top">9</td><td align="left" valign="top">Destination network administratively prohibited——目的网络被强制禁止</td><td align="middle" valign="top">　</td><td align="middle" valign="top">x</td></tr><tr><td align="middle" valign="top">3</td><td align="middle" valign="top">10</td><td align="left" valign="top">Destination host administratively prohibited——目的主机被强制禁止</td><td align="middle" valign="top">　</td><td align="middle" valign="top">x</td></tr><tr><td align="middle" valign="top">3</td><td align="middle" valign="top">11</td><td align="left" valign="top">Network unreachable for TOS——由于服务类型TOS，网络不可达</td><td align="middle" valign="top">　</td><td align="middle" valign="top">x</td></tr><tr><td align="middle" valign="top">3</td><td align="middle" valign="top">12</td><td align="left" valign="top">Host unreachable for TOS——由于服务类型TOS，主机不可达</td><td align="middle" valign="top">　</td><td align="middle" valign="top">x</td></tr><tr><td align="middle" valign="top">3</td><td align="middle" valign="top">13</td><td align="left" valign="top">Communication administratively prohibited by filtering——由于过滤，通信被强制禁止</td><td align="middle" valign="top">　</td><td align="middle" valign="top">x</td></tr><tr><td align="middle" valign="top">3</td><td align="middle" valign="top">14</td><td align="left" valign="top">Host precedence violation——主机越权</td><td align="middle" valign="top">　</td><td align="middle" valign="top">x</td></tr><tr><td align="middle" valign="top">3</td><td align="middle" valign="top">15</td><td align="left" valign="top">Precedence cutoff in effect——优先中止生效</td><td align="middle" valign="top">　</td><td align="middle" valign="top">x</td></tr><tr><td align="middle" valign="top">4</td><td align="middle" valign="top">0</td><td align="left" valign="top">Source quench——源端被关闭（基本流控制）</td><td align="middle" valign="top">　</td><td align="middle" valign="top">　</td></tr><tr><td align="middle" valign="top">5</td><td align="middle" valign="top">0</td><td align="left" valign="top">Redirect for network——对网络重定向</td><td align="middle" valign="top">　</td><td align="middle" valign="top">　</td></tr><tr><td align="middle" valign="top">5</td><td align="middle" valign="top">1</td><td align="left" valign="top">Redirect for host——对主机重定向</td><td align="middle" valign="top">　</td><td align="middle" valign="top">　</td></tr><tr><td align="middle" valign="top">5</td><td align="middle" valign="top">2</td><td align="left" valign="top">Redirect for TOS and network——对服务类型和网络重定向</td><td align="middle" valign="top">　</td><td align="middle" valign="top">　</td></tr><tr><td align="middle" valign="top">5</td><td align="middle" valign="top">3</td><td align="left" valign="top">Redirect for TOS and host——对服务类型和主机重定向</td><td align="middle" valign="top">　</td><td align="middle" valign="top">　</td></tr><tr><td align="middle" valign="top">8</td><td align="middle" valign="top">0</td><td align="left" valign="top">Echo request——回显请求（Ping请求）</td><td align="middle" valign="top">x</td><td align="middle" valign="top">　</td></tr><tr><td align="middle" valign="top">9</td><td align="middle" valign="top">0</td><td align="left" valign="top">Router advertisement——路由器通告</td><td align="middle" valign="top">　</td><td align="middle" valign="top">　</td></tr><tr><td align="middle" valign="top">10</td><td align="middle" valign="top">0</td><td align="left" valign="top">Route solicitation——路由器请求</td><td align="middle" valign="top">　</td><td align="middle" valign="top">　</td></tr><tr><td align="middle" valign="top">11</td><td align="middle" valign="top">0</td><td align="left" valign="top">TTL equals 0 during transit——传输期间生存时间为0</td><td align="middle" valign="top">　</td><td align="middle" valign="top">x</td></tr><tr><td align="middle" valign="top">11</td><td align="middle" valign="top">1</td><td align="left" valign="top">TTL equals 0 during reassembly——在数据报组装期间生存时间为0</td><td align="middle" valign="top">　</td><td align="middle" valign="top">x</td></tr><tr><td align="middle" valign="top">12</td><td align="middle" valign="top">0</td><td align="left" valign="top">IP header bad (catchall error)——坏的IP首部（包括各种差错）</td><td align="middle" valign="top">　</td><td align="middle" valign="top">x</td></tr><tr><td align="middle" valign="top">12</td><td align="middle" valign="top">1</td><td align="left" valign="top">Required options missing——缺少必需的选项</td><td align="middle" valign="top">　</td><td align="middle" valign="top">x</td></tr><tr><td align="middle" valign="top">13</td><td align="middle" valign="top">0</td><td align="left" valign="top">Timestamp request (obsolete)——时间戳请求（作废不用）</td><td align="middle" valign="top">x</td><td align="middle" valign="top">　</td></tr><tr><td align="middle" valign="top">14</td><td align="middle" valign="top">　</td><td align="left" valign="top">Timestamp reply (obsolete)——时间戳应答（作废不用）</td><td align="middle" valign="top">x</td><td align="middle" valign="top">　</td></tr><tr><td align="middle" valign="top">15</td><td align="middle" valign="top">0</td><td align="left" valign="top">Information request (obsolete)——信息请求（作废不用）</td><td align="middle" valign="top">x</td><td align="middle" valign="top">　</td></tr><tr><td align="middle" valign="top">16</td><td align="middle" valign="top">0</td><td align="left" valign="top">Information reply (obsolete)——信息应答（作废不用）</td><td align="middle" valign="top">x</td><td align="middle" valign="top">　</td></tr><tr><td align="middle" valign="top">17</td><td align="middle" valign="top">0</td><td align="left" valign="top">Address mask request——地址掩码请求</td><td align="middle" valign="top">x</td><td align="middle" valign="top">　</td></tr><tr><td align="middle" valign="top">18</td><td align="middle" valign="top">0</td><td align="left" valign="top">Address mask reply——地址掩码应答</td><td align="left" valign="top">　</td><td align="left" valign="top">　</td></tr></table>

<hr />
<b>尽管在大多数情况下,错误的包传送应该给出 ICMP 报文,但是在特殊情况下,是不产生 ICMP 错误报文的。如下:</b><br /><br />
1 ICMP 差错报文不会产生 ICMP 差错报文(出 IMCP 查询报文)(防止 IMCP 的无限产生和传送)<br />
2 目的地址是广播地址或多播地址的IP数据报。<br />
3 作为链路层广播的数据报。<br />
4 不是IP分片的第一片。<br />
5 源地址不是单个主机的数据报。这就是说,源地址不能为零地址、环回地址、广播地址或多播地址。 虽然里面的一些规定现在还不是很明白,但是所有的这一切规定,都是为了防止产生 ICMP 报文的无限传播而定义的。<br />
6 ICMP 协议大致分为两类,一种是查询报文,一种是差错报文。其中查询报文有以下几种用途:<br />
7 ping 查询(不要告诉我你不知道 ping 程序)<br />
8 子网掩码查询(用于无盘工作站在初始化自身的时候初始化子网掩码)<br />
9 时间戳查询(可以用来同步时间)<br />
<hr />